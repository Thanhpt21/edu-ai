generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                    Int                    @id @default(autoincrement())
  name                  String
  email                 String                 @unique
  password              String?
  phone                 String?
  gender                String?
  avatar                String?
  isActive              Boolean                @default(true)
  type_account          String                 @default("normal")
  role                  String                 @default("user")
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  resetToken            String?
  resetTokenExpiry      DateTime?
  
  roles                     UserRole[]
  coursesTaught             Course[]                 @relation("InstructorCourses")
  auditLogs                 AuditLog[]
  chatConversations         ChatConversation[]
  payouts                   Payout[]
  assignmentSubmissions     AssignmentSubmission[]   @relation("StudentSubmissions")
  subscriptions             UserSubscription[]
  adminAssignedChats        ChatConversation[]       @relation("AdminAssigned")
  blogsCreated              Blog[]                   @relation("UserBlogs")
  certificates              Certificate[]
  quizAttempts              QuizAttempt[]
  userBadges                UserBadge[]
  enrollments               Enrollment[]
  assignmentsGraded         AssignmentSubmission[]   @relation("GradedSubmissions")
  reviews                   Review[]
  lessonProgress            LessonProgress[]
  heygenVideos        HeygenVideo[]
  heygenAssets        HeygenAsset[]
  heygenTemplates     HeygenTemplate[] 
  avatarIVVideos   HeygenAvatarIVVideo[]
}

model Role {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
  users           UserRole[]
}

model UserRole {
  userId Int
  roleId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}

model Permission {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
}

model RolePermission {
  roleId       Int
  permissionId Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

model Course {
  id           Int        @id @default(autoincrement())
  title        String
  slug         String     @unique
  description  String?
  thumbnail    String?
  level        CourseLevel @default(BEGINNER)
  price        Float?     @default(0)
  isPublished  Boolean    @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  instructorId Int
  instructor   User       @relation("InstructorCourses", fields: [instructorId], references: [id], onDelete: Restrict)

  lessons               Lesson[]
  enrollments           Enrollment[]
  reviews               Review[]
  categories            CourseCategory[] 
  tags                  CourseTag[]       
  prerequisites         CoursePrerequisite[] @relation("CoursePrerequisites")
  requiredBy            CoursePrerequisite[] @relation("Prerequisites")
  totalViews            Int                  @default(0)
  certificates          Certificate[]
  quizzes               Quiz[]
  assignments           Assignment[]
  assignmentSubmissions AssignmentSubmission[] @relation("CourseSubmissions")
}

model CoursePrerequisite {
  id        Int    @id @default(autoincrement())
  courseId  Int
  prerequisiteCourseId Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  course       Course @relation("CoursePrerequisites", fields: [courseId], references: [id], onDelete: Cascade)
  prerequisite Course @relation("Prerequisites", fields: [prerequisiteCourseId], references: [id], onDelete: Cascade)

  @@unique([courseId, prerequisiteCourseId])
}

model Category {
  id      Int       @id @default(autoincrement())
  name    String    @unique
  description String?
  courses CourseCategory[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model CourseCategory {
  courseId   Int
  categoryId Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  @@id([courseId, categoryId])
}

model Tag {
  id      Int       @id @default(autoincrement())
  name    String    @unique
  description String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  courses CourseTag[]
}

model CourseTag {
  courseId Int
  tagId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  @@id([courseId, tagId])
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

model Lesson {
  id          Int       @id @default(autoincrement())
  title       String
  content     String?
  videoUrl    String?
  order       Int        @default(0)
  courseId    Int
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  totalViews  Int        @default(0)
  durationMin Int?

  course      Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress    LessonProgress[]
  quizzes     Quiz[]
  assignments Assignment[]
  heygenVideos HeygenVideo[]
}

model LessonProgress {
  id          Int       @id @default(autoincrement())
  userId      Int
  lessonId    Int
  completed   Boolean   @default(false)
  completedAt DateTime?

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model Enrollment {
  id          Int       @id @default(autoincrement())
  userId      Int
  courseId    Int
  enrolledAt  DateTime  @default(now())
  progress    Float?    @default(0)

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
}

model Review {
  id          Int       @id @default(autoincrement())
  courseId    Int
  userId      Int
  rating      Int
  comment     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Badge {
  id        Int      @id @default(autoincrement())
  name      String
  icon      String?
  description String?
  createdAt DateTime @default(now())
  users     UserBadge[]
}

model UserBadge {
  userId  Int
  badgeId Int
  awardedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  @@id([userId, badgeId])
}

model Assignment {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  fileUrl     String?
  dueDate     DateTime?
  maxScore    Int        @default(100)
  courseId    Int?
  lessonId    Int?
  status      AssignmentStatus @default(DRAFT)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  course      Course?    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson      Lesson?    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  submissions AssignmentSubmission[]
}

model AssignmentSubmission {
  id             Int       @id @default(autoincrement())
  assignmentId   Int
  studentId      Int
  submittedAt    DateTime  @default(now())
  fileUrl        String?
  answerText     String?
  score          Int?
  feedback       String?
  gradedById     Int?
  gradedAt       DateTime?
  courseId       Int

  course         Course     @relation("CourseSubmissions", fields: [courseId], references: [id], onDelete: Cascade)
  assignment     Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student        User       @relation("StudentSubmissions", fields: [studentId], references: [id], onDelete: Cascade)
  gradedBy       User?      @relation("GradedSubmissions", fields: [gradedById], references: [id], onDelete: SetNull)

  @@unique([assignmentId, studentId])
}

model Quiz {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  courseId    Int?
  lessonId    Int?
  duration    Int?
  isPublished Boolean    @default(false)
  randomizeQuestions Boolean @default(false)
  questionOrder Json?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  course      Course?    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson      Lesson?    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions   QuizQuestion[]
  attempts    QuizAttempt[]
}

model QuizQuestion {
  id          Int       @id @default(autoincrement())
  quizId      Int
  question    String
  options     Json
  correct     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  quiz        Quiz      @relation(fields: [quizId], references: [id], onDelete: Cascade)
}

model QuizAttempt {
  id           Int       @id @default(autoincrement())
  quizId       Int
  studentId    Int
  startedAt    DateTime  @default(now())
  submittedAt  DateTime?
  score        Int?
  answers      Json?
  attemptCount Int        @default(1)

  quiz         Quiz       @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student      User       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([quizId, studentId, attemptCount])
}

model Certificate {
  id           Int       @id @default(autoincrement())
  userId       Int
  courseId     Int
  issueDate    DateTime  @default(now())
  certificateUrl String?
  isRevoked    Boolean   @default(false)
  createdAt    DateTime  @default(now())

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  course       Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
}

model PaymentMethod {
  id        Int       @id @default(autoincrement())
  code      String    @unique
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  payments  Payment[]
}

model Payment {
  id            Int           @id @default(autoincrement())
  methodId      Int
  amount        Int
  currency      String        @default("VND")
  status        PaymentStatus @default(PENDING)
  transactionId String?       @unique
  providerData  Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  method        PaymentMethod @relation(fields: [methodId], references: [id], onDelete: Restrict)
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  action     String
  resource   String?
  resourceId Int?
  method     String
  route      String
  ip         String?
  userAgent  String?
  payload    Json?
  createdAt  DateTime @default(now())
  userId     Int?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
}

model Payout {
  id                    Int                    @id @default(autoincrement())
  receiverType          ReceiverType
  receiverId            Int?
  amount                Int
  currency              String                 @default("VND")
  status                PayoutStatus           @default(PENDING)
  method                String?
  reference             String?
  createdBy             Int?
  createdAt             DateTime               @default(now())
  processedAt           DateTime?
  user                  User?                  @relation(fields: [receiverId], references: [id], onDelete: SetNull)
}

model Config {
  id            Int      @id @default(autoincrement())
  name          String?
  email         String?
  mobile        String?
  address       String?
  googlemap     String?
  facebook      String?
  zalo          String?
  instagram     String?
  tiktok        String?
  youtube       String?
  x             String?
  linkedin      String?
  logo          String?
  banner        Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  showAddress   Boolean  @default(true)
  showEmail     Boolean  @default(true)
  showFacebook  Boolean  @default(true)
  showGooglemap Boolean  @default(false)
  showInstagram Boolean  @default(false)
  showLinkedin  Boolean  @default(false)
  showMobile    Boolean  @default(true)
  showTiktok    Boolean  @default(false)
  showX         Boolean  @default(false)
  showYoutube   Boolean  @default(false)
  showZalo      Boolean  @default(false)

  VNP_TMN_CODE  String?
  VNP_SECRET    String?
  VNP_API_URL   String?

  EMAIL_USER    String?
  EMAIL_PASS    String?
  EMAIL_FROM    String?
}

model Blog {
  id          Int      @id @default(autoincrement())
  title       String
  slug        String   @unique
  description String
  thumb       String?
  content     Json
  numberViews Int      @default(0)
  isPublished Boolean  @default(false)
  createdById Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   User     @relation("UserBlogs", fields: [createdById], references: [id], onDelete: Cascade)
}

model Contact {
  id        Int           @id @default(autoincrement())
  name      String
  email     String
  phone     String
  message   String
  status    ContactStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model ChatConversation {
  id              Int                    @id @default(autoincrement())
  userId          Int?
  sessionId       String?
  assignedAdminId Int?
  status          ChatConversationStatus @default(ACTIVE)
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  user            User?                  @relation(fields: [userId], references: [id], onDelete: SetNull)
  admin           User?                  @relation("AdminAssigned", fields: [assignedAdminId], references: [id], onDelete: SetNull)
  messages        ChatMessage[]

  @@index([sessionId])
  @@index([userId])
  @@index([assignedAdminId])
}

model ChatMessage {
  id             Int              @id @default(autoincrement())
  conversationId Int
  senderId       Int?
  senderType     SenderType
  message        String
  metadata       Json?
  sessionId      String?
  isRead         Boolean          @default(false)
  createdAt      DateTime         @default(now())
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([sessionId])
}

model PromptAI {
  id        Int            @id @default(autoincrement())
  name      String
  text      String
  status    PromptAIStatus
  position  Int
  startDate DateTime
  endDate   DateTime
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([status])
}

model SubscriptionPlan {
  id       Int    @id @default(autoincrement())
  name     String
  price    Float
  durationDays Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users    UserSubscription[]
}

model UserSubscription {
  id          Int @id @default(autoincrement())
  userId      Int
  planId      Int
  startDate   DateTime @default(now())
  endDate     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  status      SubscriptionStatus @default(ACTIVE)
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan        SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Restrict)
}

model Coupon {
  id        Int @id @default(autoincrement())
  code      String @unique
  discount  Float
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model HeygenAvatar {
  id              Int      @id @default(autoincrement())
  avatarId        String   @unique  // HeyGen avatar_id
  name            String
  displayName     String?
  gender          String?
  preview_image   String?
  preview_video   String?
  avatar_style    String   @default("normal")
  is_customized   Boolean  @default(false)
  is_instant      Boolean  @default(false)
  is_premium      Boolean  @default(false)
  is_free         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  videos          HeygenVideo[]
  templates HeygenTemplate[]
  
  @@index([avatarId])
  @@index([is_premium])   
  @@index([is_free])      
}

model HeygenVoice {
  id              Int      @id @default(autoincrement())
  voiceId         String   @unique  // HeyGen voice_id
  name            String
  displayName     String?
  gender          String?
  language        String?
  language_code   String?
  preview_audio   String?
  is_customized   Boolean  @default(false)

  is_premium      Boolean  @default(false)
  is_free         Boolean  @default(true)
  tier            String?  @default("free")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  videos          HeygenVideo[]
  templates HeygenTemplate[]
  
  @@index([voiceId])
  @@index([language])
  @@index([is_premium])    
  @@index([is_free])       
  @@index([tier])          
}

model HeygenVideo {
  id                  Int              @id @default(autoincrement())
  videoId             String           @unique  // HeyGen video_id
  userId              Int?
  lessonId            Int?
  avatarId            Int
  voiceId             Int
  title               String?
  inputText           String           // Input text for avatar to speak
  status              HeygenVideoStatus @default(PENDING)
  
  // Background settings
  backgroundType      String?          // color, image, video
  backgroundColor     String?          // Hex code
  backgroundImageUrl  String?
  backgroundVideoUrl  String?
  backgroundPlayStyle BackgroundPlayStyle?          // fit_to_scene, freeze, loop, full_video
  
  // Video settings
  dimensionWidth      Int              @default(1280)
  dimensionHeight     Int              @default(720)
  isWebM              Boolean          @default(false)  // Transparent WebM format

  supabaseVideoUrl String?   // URL video trên Supabase
  isDownloaded     Boolean   @default(false) // Đã download chưa
  downloadedAt     DateTime? // Thời điểm download
  
  // Result
  videoUrl            String?
  thumbnailUrl        String?
  duration            Float?           // Duration in seconds
  errorMessage        String?
  
  // Metadata
  metadata            Json?            // Store additional HeyGen response data
  
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  completedAt         DateTime?
  retryCount          Int               @default(0)
  maxRetries          Int               @default(3) 
  lastError           String? 
  webhookSecret  String?    @unique  // Secret cho mỗi video
  
  user                User?            @relation(fields: [userId], references: [id], onDelete: SetNull)
  lesson              Lesson?          @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  avatar              HeygenAvatar     @relation(fields: [avatarId], references: [id], onDelete: Restrict)
  voice               HeygenVoice      @relation(fields: [voiceId], references: [id], onDelete: Restrict)
  
  @@index([userId])
  @@index([lessonId]) 
  @@index([status])
  @@index([createdAt])
}

model HeygenAsset {
  id              Int              @id @default(autoincrement())
  assetId         String           @unique  // HeyGen asset_id
  assetType       HeygenAssetType  // image, video, audio
  name            String
  url             String
  fileSize        Int?             // File size in bytes
  duration        Float?           // Duration for video/audio
  uploadedBy      Int?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  user            User?            @relation(fields: [uploadedBy], references: [id], onDelete: SetNull)
  
  @@index([assetType])
  @@index([uploadedBy])
}

model HeygenTemplate {
  id              Int      @id @default(autoincrement())
  name            String
  description     String?
  avatarId        Int
  voiceId         Int
  backgroundType  String?
  backgroundColor String?
  backgroundUrl   String?
  backgroundPlayStyle BackgroundPlayStyle?
  inputText       String?  // Default text template
  isPublic        Boolean  @default(false)
  createdBy       Int?
  usageCount      Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  avatar          HeygenAvatar @relation(fields: [avatarId], references: [id], onDelete: Restrict)
  voice           HeygenVoice  @relation(fields: [voiceId], references: [id], onDelete: Restrict)
  creator         User?        @relation(fields: [createdBy], references: [id], onDelete: SetNull)
  
  @@index([isPublic])
  @@index([createdBy])
}

model HeygenAvatarIVVideo {
  id               Int       @id @default(autoincrement())
  videoId          String?   @unique  // video_id từ HeyGen response
  title            String    // video_title
  imageKey         String    // image_key từ upload
  script           String
  voiceId          String    // voice_id từ HeygenVoice
  language         String    @default("vi")
  customMotion     String?   // custom_motion_prompt
  enhanceMotion    Boolean   @default(false) // enhance_custom_motion_prompt
  status           String    @default("processing") // processing, completed, failed
  videoUrl         String?   // video_url từ HeyGen
  errorMessage     String?   // error message nếu failed
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Liên kết với user (nếu có hệ thống user)
  userId           Int?
  user             User?     @relation(fields: [userId], references: [id])

  @@index([videoId])
  @@index([status])
  @@index([userId])
  @@index([createdAt])
}


enum HeygenVideoStatus {
  PENDING      // Queued and waiting
  WAITING      // In waiting state
  PROCESSING   // Currently rendering
  COMPLETED    // Successfully rendered
  FAILED       // Failed to render
}

enum HeygenAssetType {
  IMAGE
  VIDEO
  AUDIO
}

enum BackgroundPlayStyle {
  FIT_TO_SCENE
  FREEZE
  LOOP
  FULL_VIDEO
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum ChatConversationStatus {
  ACTIVE
  CLOSED
  ARCHIVED
}

enum ContactStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum SenderType {
  USER
  GUEST
  BOT
  ADMIN
}

enum ReceiverType {
  USER
  INSTRUCTOR
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum PromptAIStatus {
  ACTIVE
  INACTIVE
  DELETED
}

enum AIProvider {
  OPENAI
  GEMINI
  CLAUDE
  CUSTOM
}
